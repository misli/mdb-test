#!/bin/bash

NVR="$1"

if [[ "$NVR" =~ ^(|-h|--help)$ ]]; then
    echo -e "Usage:"
    echo -e "\t$0 <nvr>"
    exit 0
fi

LOGS="$PWD/$NVR/logs"
RESULTS="$PWD/$NVR/results"

for koji in {,{arm,ppc,s390}-}koji; do
    $koji download-logs -c --recurse --dir=$LOGS --match=build.log --nvr $NVR &
done; wait

for LOG in $(find $LOGS -name build.log); do
    {
        ARCH=$(egrep '^Building for target' $LOG | tail -1 | sed 's/.* //')
        echo >&2 "Processing log $LOG for arch $ARCH"
        mkdir -p "$RESULTS/$ARCH"
        while read LINE; do
            [[ "$LINE" =~ \[\ fail\ \]$ ]] || continue
            TEST=${LINE/ */}
            while ! [[ "$LINE" =~ the\ logfile\ can\ be\ found\ in ]]; do
                echo "$LINE"
                read LINE || break
            done > "$RESULTS/$ARCH/$TEST"
        done < $LOG
    } &
done; wait
